# Audio Upload Service

Сервис позволяет пользователям загружать аудио-файлы, проходить авторизацию через Яндекс OAuth и управлять своими данными. В реализации используется FastAPI, SQLAlchemy, асинхронный код и PostgreSQL 16. Файлы сохраняются локально, без использования облачного хранилища.

## Возможности

- **Авторизация через Яндекс OAuth**  
  Пользователь проходит авторизацию через Яндекс, после чего ему выдаётся внутренний JWT‑токен для доступа к API.
- **Эндпоинты:**
  - **Авторизация:**
    - `GET /auth/login` – перенаправление на страницу авторизации Яндекса.
    - `GET /auth/callback` – обработка callback от Яндекса, получение информации о пользователе и выдача JWT‑токена.
    - `POST /auth/refresh` – обновление внутреннего access_token.
  - **Управление пользователями:**
    - `GET /users/me` – получение данных текущего пользователя.
    - `PUT /users/me` – обновление данных пользователя.
    - `DELETE /users/{user_id}` – удаление пользователя (только для суперпользователя).
  - **Работа с аудио-файлами:**
    - `POST /files/upload` – загрузка аудио-файла с указанием его имени.
    - `GET /files/` – получение списка загруженных аудио-файлов (имя файла и путь к локальному хранилищу).

## Структура проекта

```
project/
├── app/
│   ├── __init__.py
│   ├── main.py
│   ├── config.py
│   ├── database.py
│   ├── models.py
│   ├── schemas.py
│   ├── auth.py
│   ├── routers/
│   │   ├── __init__.py
│   │   ├── auth.py
│   │   ├── users.py
│   │   └── files.py
│   └── services/
│       ├── __init__.py
│       ├── user_service.py
│       └── file_service.py
├── Dockerfile
├── docker-compose.yml
├── requirements.txt
├── .env.example
├── .gitignore
└── README.md
```

## Настройка переменных окружения

Для безопасного хранения ключей и настроек используется файл `.env`. Создайте файл `.env` в корне проекта на основе шаблона `.env.example`:

**.env.example**

```env
YANDEX_CLIENT_ID=your_yandex_client_id
YANDEX_CLIENT_SECRET=your_yandex_client_secret
SECRET_KEY=your_secret_key
ACCESS_TOKEN_EXPIRE_MINUTES=30
DATABASE_URL=postgresql+asyncpg://postgres:postgres@db:5432/postgres
```

**Важно:**  
- Добавьте файл `.env` в `.gitignore`, чтобы ключи не попали в репозиторий:

```gitignore
# .gitignore
.env
```

## Установка и запуск

### Требования

- Docker и Docker Compose

### Шаги для запуска:

1. **Клонируйте репозиторий:**

   ```bash
   git clone https://github.com/lolevan/AudioVault.git
   cd AudioVault
   ```

2. Отредактируйте файл `.env` и укажите свои значения для:
   - `YANDEX_CLIENT_ID`
   - `YANDEX_CLIENT_SECRET`
   - `SECRET_KEY`

3. **Соберите и запустите контейнеры с помощью Docker Compose:**

   ```bash
   docker-compose up --build
   ```

4. **Доступ к API:**

   Сервис будет доступен по адресу: [http://localhost:8000](http://localhost:8000)

5. **Документация по API:**

   Для просмотра интерактивной документации перейдите по адресу [http://localhost:8000/docs](http://localhost:8000/docs)

## Описание эндпоинтов

### Авторизация

- **GET `/auth/login`**  
  Перенаправляет пользователя на страницу авторизации Яндекса.

- **GET `/auth/callback`**  
  Обрабатывает ответ от Яндекса, получает данные пользователя и генерирует внутренний JWT‑токен.

- **POST `/auth/refresh`**  
  Обновляет JWT‑токен для текущего пользователя.

### Управление пользователями

- **GET `/users/me`**  
  Возвращает информацию о текущем аутентифицированном пользователе.

- **PUT `/users/me`**  
  Позволяет обновить данные пользователя (например, `full_name`).

- **DELETE `/users/{user_id}`**  
  Удаляет пользователя. Доступно только суперпользователю.

### Работа с аудио-файлами

- **POST `/files/upload`**  
  Загружает аудио-файл. Принимает файл (через `multipart/form-data`) и имя файла (параметр `file_name`). Файл сохраняется в локальной директории `uploaded_files`.

- **GET `/files/`**  
  Возвращает список аудио-файлов, загруженных текущим пользователем, с указанием имени и пути хранения.

## Примечания

- **Безопасность:**  
  Все секретные ключи и настройки хранятся в файле `.env`, который не должен попадать в репозиторий. Это демонстрирует хорошие практики разработки даже для тестового задания.

- **Асинхронность:**  
  В проекте используется асинхронный доступ к базе данных (SQLAlchemy с asyncpg) и асинхронное сохранение файлов (aiofiles).

- **OAuth через Яндекс:**  
  Для корректного функционирования OAuth убедитесь, что в настройках вашего приложения в Яндекс указаны правильные redirect_uri (например, `http://localhost:8000/auth/callback`).

- **Директория загрузки файлов:**  
  Директория `uploaded_files` создаётся автоматически, если не существует, и должна быть доступна для записи приложением.

## Развертывание в Production

При переходе в production‑среду рекомендуется:
- Использовать HTTPS для обеспечения безопасности соединений.
- Хранить секреты в защищённых хранилищах (например, Vault, переменные окружения на сервере и т.д.).
- Настроить надёжный логинг и мониторинг.

---

Эта документация поможет вам развернуть и протестировать сервис для загрузки аудио-файлов с авторизацией через Яндекс OAuth.
